# 大作业实验指导书

大作业框架面向《程序设计基础》课程的大作业实验项目，原则上所有同学必须使用该框架完成指定的大作业题目，如果有同学想要使用其他框架完成大作业或者选择其他的大作业题目，请提前联系助教确认。

本次大作业实验的题目是《飞机大战》，一款耳熟能详的游戏。想必各位同学从小到大或多或少玩过类似的游戏，比如“QQ雷电”等。在本次大作业实验中，同学们将基于Windows桌面应用程序利用Win32 API实现一款《飞机大战》游戏，提升自身的编程能力。

这是同学们为数不多能学习并编写较大桌面应用程序的机会，和在OJ上写代码完全不一样，请同学们认真对待，抓住这次机会。在本次大作业实验中，同学们将掌握以下能力：

- 使用Win32 API来编写桌面应用程序，理解事件驱动的程序设计方式
- 了解预编译的相关内容（宏），熟练使用结构体和指针，掌握Debug方式
- 如何进行多文件编程，如何编写头文件和源文件，如何高效、内聚地组织代码
- 了解最基本的游戏运行逻辑，体会一个简单的游戏框架
- 大幅度提高编程能力，将自身所想实际实现出来

## 0. 写在前面

在开始大作业之前，请同学先学习以下前置知识。

### 文档查询

请同学们掌握文档查询能力，尤其是在编写大作业的过程中，可能会遇到许多没用过的函数（Win32 API函数等），这种时候可以用鼠标点击让光标停留在该函数上，然后按键盘上`F1`键，这将跳转到对应的微软MSDN文档函数说明，在文档中你将看到函数的参数、返回值，已经产生的效果。

### 预编译

预编译做的只有一件事——字符串替换！牢记这件事，看下面的例子。

> `##`可以在预编译时进行字符串拼接。
>
> `#include`就是把头文件原封不动地粘贴到这里。

```cpp
#define ID 1
int id = ID;  // 预编译之后就是 int id = 1;

#define M
#ifdef M
int m = 1;
#else 
int m = 2;
#endif
// 预编译之后就是 int m = 1;

#define ADD(a, b) a + b
int x = add(1, 2);  // 预编译之后就是 int x = 1 + 2;

#define CONCATENATE(STR1, STR2)  STR1##STR2
const char* str = CONCATENATE("Hello, ", "World!");
// 预编译之后就是 const char* str = "Hello, ""World!"

#define Funf(FunctionName)  FunctionName##f
Funf(print)("%d", 1);
// 预编译之后就是 printf("%d", 1);
```

> 有疑惑的同学可以自己先试一试！

### 函数先声明再调用

程序编译是自上而下的，函数应该先声明再调用，否则在调用时，并不知道函数长什么样。

```cpp
int fun(int param);  // 声明一个函数

int main() {
    fun(0);  // 声明后才能调用
    return 0;
}

// 函数定义可以在任何地方
int fun(int param) {
    return 0;
}
```

函数必须先声明再调用，函数定义可以在**任何地方**，包括声明时直接定义，或者定义在另一个`.cpp`文件中，这是多文件编程的基础。

声明只是为了能正常**编译**，`.cpp`文件**编译**后还会进行**链接**，此时会把函数调用定位到具体的定义位置，因此函数定义可以放在任何地方。

> 感兴趣的可以去整体了解下 预编译->编译->链接 可执行文件生成过程。

### 语言关键字

#### `static`关键字

`static`关键字在不同地方起到的作用不一样，如果在函数里，将声明一个静态变量，只在函数第一次运行的时候执行变量初始化，后面变量将不再初始化，可以用这个特性，在多次调用函数时共享某个值。

> 实质上类似全局变量，但只能在函数内部访问。

```cpp
int fun() {
    static int a = 0;  // 初始化只进行一次！
    a = a + 1;
    return a; // 返回的结果将是1、2、3、4、5、…… 
}
```

`static`关键字如果作用于全局变量或者函数声明之前，将限制该全局变量或者函数只能在本`.cpp`文件中调用，可以用这个特性来阻止其他文件调用某函数。

> 大作业框架中使用了这个特性，同学们能看懂即可，是否使用不作强制要求。

```cpp
static int a = 0;  // 这个全局变量在其他文件中不能访问
int b = 0;  // 这个全局变量可以在其他文件中访问

static void fun1();  // 这个函数不能在其他文件中调用
void fun2();  // 这个函数可以在其他文件中调用
```

#### `extern`关键字

`extern`关键字用来声明访问其他`.cpp`文件中的没有被`static`修饰的全局变量。

> 这个也是多文件编程的基础。

```cpp
// A.cpp
int a = 0;

// B.cpp
extern int a;  // 和A.cpp文件中的a是同一个变量，指向相同的内存空间，修改任意一个，另一个的值也会变
```

#### `new`关键字

虽然可以用`malloc`分配空间，但是用`new`会更现代一点。

```cpp
struct A {
    int a;
}

A* a = new A();  // 创建一个结构体
```

#### `delete`关键字

正如`free`对应`malloc`分配空间，用`delete`来删除`new`出来的对象。

```cpp
A* a = new A();
delete a;

int* arr = new int[10]();
delete[] arr;
```

### Visual Studio使用方式

#### 声明定义快速预览

在Visual Studio中，按住键盘Ctrl键再用鼠标点击某个函数，可以快速转到这个函数的声明或者定义。

或者右键点击这个函数，选择“转到声明”或者“转到定义”，也可以快速切换。

或者按键盘上F12按键，可以快速切换

#### 查找所有引用

右击某个函数，选择“查找所有引用”可以快速查找该函数的所有引用。

类似地，可以右击某个函数，可以“查找调用层次结构”、“速览、切换标题/代码文件”等。

> Ctrl + K 然后 T、Ctrl + K 然后 J、Ctrl + K 然后 O 等快捷键都可以试试看

#### 编译运行调试

编译 - Ctrl + Shift + B

开始执行（不调试）- Ctrl + F5

开始调试 - F5

断点 - F9 或者 点击代码行最左边

逐行运行（步过） - F10

逐行运行（步入） - F11

可以触摸变量查看变量的值，或者在下面变量窗口查看

> 以上快捷键同学们可以尽量熟悉，提高效率

### C++ STL

大作业框架为了方便不可避免地使用了一些C++ STL相关的内容，包括：

- `std::set<T>`：[用法](https://en.cppreference.com/w/cpp/container/set.html)，有序集合，用于存储无重复的内容，默认升序存储
- `std::vector<T>`：[用法](https://en.cppreference.com/w/cpp/container/vector.html)，向量，可以自动扩容的数组

虽然C++ STL不在本课程要求范围内，但是仍然估计同学了解学习。`<T>`模板参数，代表实际存储的类型。`std::`是命名空间，STL的内容大都在`std`命名空间中，命名空间目的防止函数重名。

（至少需要掌握以下内容）关于`std::set`的用法：

```cpp
#include <set>

int main() {
    std::set<int> s;
    s.insert(3);  // 插入一个元素
    s.insert(4);  // 插入一个元素
    s.erase(3);  // 删除一个元素
	int n = s.size();  // 集合大小
    // 遍历方式（将是升序的顺序）
    for (int num : s) {
        printf("%d\n", num);
    }
}
```

（至少需要掌握以下内容）关于`std::vector`的用法：

```cpp
#include <vector>

int main() {
    std::vector<int> v;
    v.push_back(3);  // 往最后插入一个元素
    v.push_back(4);  // 往最后插入一个元素
    v.pop_back(3);  // 弹出最后一个元素
    int n = v.size(); // 数组大小
    int a = v[0];  // 第i个元素（下标从0开始）
    // 遍历方式1
    for (int num : v) {
        printf("%d\n", num);
    }
    // 遍历方式2
    for (int i = 0; i < n; i++) {
        printf("%d\n", v[i]);
    }
}
```

## 1. 框架预览

同学们下载完框架代码后，可以双击`Game.sln`打开解决方案。

首先尝试编译运行，理应可以成功运行。

### 框架结构

![](images/framework.png)

这个大作业框架的代码结构如上图所示，分为Win32应用程序部分、游戏框架部分和场景逻辑部分。

